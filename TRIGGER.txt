create trigger correggiaperte
before update of corretta on rispostaaperta
for each row
when(new.corretta=true)
execute function correggiaperte();
create function correggiaperte() returns trigger as $$
begin
	if(new.voto is NULL)then
	new.corretta=false;
end if;
	return new;
end;
$$ language plpgsql;



create trigger correggimultipla
before insert on rispostamultipla
for each row
execute function correzionemultipla();
create function correzionemultipla() returns trigger as $$
Declare
	quiz quizarispostamultipla%rowtype;
BEGIN
	
	Select * Into quiz
	from quizarispostamultipla
	where nome=new.quiz;
	if(new.risposta=quiz.rispostacorretta)then
		new.voto=quiz.votorispostacorretta;
	else
		new.voto=quiz.votorispostasbagliata;
	end if;
	return new;
end
$$ language plpgsql;



create trigger sceltacorretto
before update of corretto on scelta
for each row
when(new.corretto=true)
execute function scorretto();
create function scorretto() returns trigger as $$
declare
sum1 float;
sum2 float;

Begin
	if((Select nome 
		from quizarispostaaperta 
		where test=new.test  AND nome NOT IN(
			Select quiz 
			From rispostaaperta 
			where corretta=true AND studente=new.studente AND quiz IN (
																		 Select nome
																		 From quizarispostaaperta
																		 Where test=new.test
			) )) IS NULL AND new.termina=true) then
		
		Select SUM(ra.voto) INTO sum1
		FROM rispostaaperta AS ra 
		WHERE ra.studente=new.studente AND ra.quiz IN(
			SELECT nome 
			FROM quizarispostaaperta 
			WHERE test=new.test);
			
		Select SUM(rm.voto) INTO sum2
		FROM rispostamultipla as rm
		where rm.studente=new.studente AND rm.quiz IN (
				SELECT nome 
				FROM quizarispostamultipla 
				WHERE test=new.test);
		new.voto=sum1+sum2;
	else
		raise notice 'non sono stati tutti corretti o non Ã¨ terminato';
		new.corretto=false;
	end if;
	return new;
end
$$ language plpgsql;


create trigger sceltaterminato
before update of termina on scelta
for each row
when(new.termina=true)
execute function tscelta();
create function tscelta() returns trigger as $$
BEGIN
	if(((Select nome 
		 from quizarispostaaperta 
		 where test=new.test AND nome not IN (
			 SELECT quiz 
			 FROM rispostaaperta 
			 WHERE studente=new.studente and quiz IN (select nome
													  from quizarispostaaperta
													  where test=new.test))) IS not NULL)
	   
	   OR 
	   	
	   ((Select nome 
		 from quizarispostamultipla 
		 where test=new.test AND nome not IN (
			 SELECT quiz 
			 FROM rispostamultipla 
			 WHERE studente=new.studente and quiz IN (select nome
													   from quizarispostamultipla
													   where test=new.test))) IS not NULL )) then
		
		
		
		RAISE NOTICE 'NON SONO STATE INSERITE TUTTE LE RISPOSTE';
		new.termina:=false;
	else
		new.data:=current_timestamp;
	end if; 
	return new;
END;
$$ language plpgsql;